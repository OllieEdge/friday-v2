#!/usr/bin/env bash
set -euo pipefail

# One-time setup on the Mac mini (run as user `ollie`).
#
# This script:
# - writes a LaunchAgent to run Friday v2 on port 3334
# - starts it via launchctl
#
# nginx (443 + subdomain) is configured separately and requires sudo for reload.

ROOT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")/../.." >/dev/null 2>&1 && pwd)"

PLIST="$HOME/Library/LaunchAgents/com.friday.v2.plist"
mkdir -p "$HOME/Library/Logs/friday-v2"

NODE_BIN="${NODE_BIN:-}"
NPM_BIN="${NPM_BIN:-}"

if [[ -z "${NODE_BIN}" ]]; then
  if [[ -x "/opt/homebrew/bin/node" ]]; then NODE_BIN="/opt/homebrew/bin/node"; else NODE_BIN="$(command -v node || true)"; fi
fi
if [[ -z "${NPM_BIN}" ]]; then
  if [[ -x "/opt/homebrew/bin/npm" ]]; then NPM_BIN="/opt/homebrew/bin/npm"; else NPM_BIN="$(command -v npm || true)"; fi
fi

if [[ -z "${NODE_BIN}" || ! -x "${NODE_BIN}" ]]; then
  echo "ERROR: node not found. Install Node 22+ (required for node:sqlite) or set NODE_BIN." >&2
  exit 1
fi
if [[ -z "${NPM_BIN}" || ! -x "${NPM_BIN}" ]]; then
  echo "ERROR: npm not found. Install npm or set NPM_BIN." >&2
  exit 1
fi

export PATH
PATH="$(dirname "${NODE_BIN}")":"$(dirname "${NPM_BIN}")":"${PATH}"

if [[ ! -f "${ROOT_DIR}/.env" && -f "${ROOT_DIR}/.env.example" ]]; then
  echo "Creating .env (default runner=settings)…"
  cat >"${ROOT_DIR}/.env" <<EOF
# Generated by tools/mac-mini/setup.sh (safe to edit; do not commit)
FRIDAY_RUNNER=settings
CODEX_PATH=
CODEX_MODEL=gpt-5.2-2025-12-11

# Cost estimation (USD per 1K tokens) used by the UI.
METERED_USD_PER_1K_INPUT=0.001751
METERED_USD_PER_1K_CACHED_INPUT=0.000175
METERED_USD_PER_1K_OUTPUT=0.013992
EOF
fi

echo "Installing deps + building UI…"
(cd "$ROOT_DIR" && "${NPM_BIN}" install && "${NPM_BIN}" run build)

cat >"$PLIST" <<PLIST
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
  <dict>
    <key>Label</key><string>com.friday.v2</string>
    <key>WorkingDirectory</key><string>${ROOT_DIR}</string>
    <key>ProgramArguments</key>
    <array>
      <string>${NODE_BIN}</string>
      <string>${ROOT_DIR}/server/server.js</string>
    </array>
    <key>EnvironmentVariables</key>
    <dict>
      <key>PORT</key><string>3334</string>
      <key>NODE_ENV</key><string>production</string>
    </dict>
    <key>RunAtLoad</key><true/>
    <key>KeepAlive</key><true/>
    <key>StandardOutPath</key><string>${HOME}/Library/Logs/friday-v2/out.log</string>
    <key>StandardErrorPath</key><string>${HOME}/Library/Logs/friday-v2/err.log</string>
  </dict>
</plist>
PLIST

launchctl unload "$PLIST" >/dev/null 2>&1 || true
launchctl load "$PLIST"

for _ in {1..12}; do
  if curl -sS --max-time 2 "http://127.0.0.1:3334/api/health" >/dev/null; then
    curl -sS --max-time 2 "http://127.0.0.1:3334/api/health"
    echo
    exit 0
  fi
  sleep 0.5
done

echo "ERROR: Friday v2 did not become healthy on http://127.0.0.1:3334/api/health" >&2
exit 1
